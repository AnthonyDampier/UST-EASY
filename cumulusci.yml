minimum_cumulusci_version: '3.15.0.dev2'
project:
    name: EASY-Open-Source-Solution
    package:
        name:  EASY-Open-Source-Solution
        api_version: '48.0'
    dependencies:
        - github: 'https://github.com/SalesforceFoundation/EDA'
    source_format: sfdx

tasks:
    robot:
        options:
            suites: robot/EASY-Open-Source-Solution/tests
            options:
                outputdir: robot/EASY-Open-Source-Solution/results

    robot_testdoc:
        options:
            path: robot/EASY-Open-Source-Solution/tests
            output: robot/EASY-Open-Source-Solution/doc/EASY-Open-Source-Solution_tests.html

    run_tests:
        options:
            required_org_code_coverage_percent: 75

    create_community:
        description: Deploys configuration for Development.
        class_path: cumulusci.tasks.salesforce.CreateCommunity
        options:
            name: EASY Applicant Portal
            description: EASY application portal
            template: Build Your Own
            url_path_prefix: EASYApp

    permission_guest_user:
        description: 'Applies permission set to guest community guest user'
        class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
        options:
            apex: >

                Site site = [
                    SELECT GuestUserId
                    FROM Site
                    WHERE Name = 'EASY_Applicant_Portal'
                ];

                List<PermissionSet> guestPermissionSet = [
                    SELECT Name, Id
                    FROM PermissionSet
                    WHERE Name = 'Application_Community_Guest'
                ];

                List<PermissionSetAssignment> permissionSetList = new List<PermissionSetAssignment>();

                if(!guestPermissionSet.isEmpty()) {
                    permissionSetList.add(new PermissionSetAssignment(PermissionSetId = guestPermissionSet[0].Id, AssigneeId = site.GuestUserId));
                }

                if (!permissionSetList.isEmpty()) {
                    upsert permissionSetList;
                }

    permission_admin_user:
        description: 'Applies permission set to guest community guest user'
        class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
        options:
            apex: >

                List<PermissionSet> adminPermissionSets = [
                    SELECT Name, Id FROM PermissionSet
                    WHERE Name = 'Application_Admin'
                ];

                List<PermissionSetAssignment> permissionSetList = new List<PermissionSetAssignment>();

                if(!adminPermissionSets.isEmpty()) {
                    for (User u : [SELECT ID FROM User WHERE Profile.Name = 'System Administrator']) {
                        permissionSetList.add(new PermissionSetAssignment(PermissionSetId = adminPermissionSets[0].Id, AssigneeId = u.Id));
                    }
                }

                if (!permissionSetList.isEmpty()) {
                    upsert permissionSetList;
                }

    set_easy_custom_settings:
        description: 'Applies permission set to guest community guest user'
        class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
        options:
            apex: >

                Site site = [
                        SELECT GuestUserId
                        FROM Site
                        WHERE Name = 'EASY_Applicant_Portal'
                ];

                List<Profile>  easyProfile = [
                    SELECT Name, Id FROM Profile
                    WHERE Name = 'EASY Applicant Portal Profile'
                ];

                List<PermissionSet> easyCommunityPermissionSet = [
                        SELECT Id, Name FROM PermissionSet WHERE Name = 'Application_Community'
                ];

                String path = '/sites/servlet.SiteDebugMode';
                PageReference pr = new PageReference(path);
                pr.getParameters().put('guid', site.GuestUserId);
                pr.getParameters().put('sitedebugmode', 'x');
                String url = pr.getContent().toString().substringAfter('URL=').substringBefore(path);

                Application_Setting__c applicationSettings = Application_Setting__c.getOrgDefaults();
                applicationSettings.Community_URL__c = url;

                if (easyProfile.size() > 0) {
                    applicationSettings.Community_Profile_Ids__c = easyProfile[0].Id;
                }

                if (easyCommunityPermissionSet.size() > 0) {
                    applicationSettings.Permission_Set_Id__c =  easyCommunityPermissionSet[0].Id;
                }

                upsert applicationSettings;

    set_hierarchy_custom_settings:
        description: 'Set UST EDA hierarchy settings'
        class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
        options:
            apex: >
                hed__Hierarchy_Settings__c hierarchySettings = hed__Hierarchy_Settings__c.getOrgDefaults();
                hierarchySettings.hed__Admin_Account_Naming_Format__c = '{!LastName} Administrative Account';
                hierarchySettings.hed__Household_Account_Naming_Format__c = '{!LastName} ({!{!FirstName}}) Household';
                hierarchySettings.hed__Admin_Account_Naming_Format__c = '{!LastName} ({!{!FirstName}}) Administrative Account';
                upsert hierarchySettings;

    set_review_custom_settings:
        description: 'Applies related object review settings per UST needs'
        class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
        options:
            apex: >
                insert new Related_Object_Review__c (Name='hed__Attribute__c');
                insert new Related_Object_Review__c (Name='hed__Contact_Language__c');
                insert new Related_Object_Review__c (Name='hed__Education_History__c');
                insert new Related_Object_Review__c (Name='hed__Test__c');

    load_application_data:
        description: 'Load data needed to start EASY applications'
        class_path: cumulusci.tasks.bulkdata.load.LoadData
        options:
            mapping: datasets/dev/mapping.yml
            sql_path: datasets/dev/data.sql

    configure_community:
        description: Deploys Network config for community for Development.
        class_path: cumulusci.tasks.salesforce.Deploy
        options:
            namespace_inject: $project_config.project__package__namespace
            path: unpackaged/config/network
            unmanaged: True

    deploy_site_config:
        description: Deploys configuration for Development.
        class_path: cumulusci.tasks.salesforce.Deploy
        options:
            namespace_inject: $project_config.project__package__namespace
            path: unpackaged/config/site
            unmanaged: True

    set_user_user_role:
        description: 'Apply the Easy Applicant user role to default user'
        class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
        options:
            apex: >
                List<User> userUsers = [SELECT Name FROM User WHERE Name = 'User User'];

                List<UserRole> roles = [SELECT Name, Id FROM UserRole WHERE Name = 'EASY Applicant'];

                List<PermissionSet> permissionSets = [SELECT Id, Name FROM PermissionSet WHERE Name = 'Application_Community'];

                if (userUsers.size() > 0) {
                    if(roles.size() > 0) {
                        userUsers[0].UserRoleId = roles[0].Id;
                        if (permissionSets.size() >0 ) {
                            userUsers[0].Community_Permissions__c = permissionSets[0].Id;
                        }
                        update userUsers[0];
                    }
                }

    activate_community_permissions_trigger:
        description: 'Turns on the trigger that applies permissions sets via community permissions field on user'
        class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
        options:
            apex: >
                hed__Trigger_Handler__c permissionTrigger = new hed__Trigger_Handler__c();
                permissionTrigger.Name = 'User Community Permissions';
                permissionTrigger.hed__Active__c = true;
                permissionTrigger.hed__Class__c = 'User_Community_Permission_TDTM';
                permissionTrigger.hed__Load_Order__c = 2.0;
                permissionTrigger.hed__Object__c = 'User';
                permissionTrigger.hed__Trigger_Action__c = 'AfterInsert;AfterUpdate';
                insert permissionTrigger;


flows:
    config_dev:
        steps:
            3:
                task: create_community
            4:
                task: permission_guest_user
            5:
                task: permission_admin_user
            6:
                task: set_easy_custom_settings
            7:
                task: set_hierarchy_custom_settings
            8:
                task: set_review_custom_settings
            9:
                task: load_application_data
            10:
                task: configure_community
            11:
                task: deploy_site_config
            12:
                task: activate_community_permissions_trigger
            13:
                task: set_user_user_role
